#!/usr/bin/env ruby
# encoding: Windows-1251

require_relative 'start_script'

# This script replicates SimpleSend.js functionality

start_router do

# Creating Connection - global var since we need to access it inside Object#loop_loop
  $conn = P2::Connection.new(:app_name => "RbConnEvents",
                             :host => "127.0.0.1",
                             :port => 4001)

  def loop_loop
    start = Time.now
    while Time.now-start < 0.05
      $conn.ProcessMessage2(100)
#      WIN32OLE_EVENT.message_loop
      print '.'
    end
    p $conn.status_text
  end

  $conn.events.on_event do |*args|
    p "EVENT!!!!!!! #{args.inspect}"
    args[1].ole_type.tap { |k| p [k.name, k.progid, k.guid, k.implemented_ole_types] }
    p $conn.status_text
  end

  print "Event handler created"

  loop_loop
  puts "Connecting"
  error = $conn.Connect() # устанавливаем соединение с локальным роутером

  loop_loop
  puts "Disconnecting"
  error = $conn.Disconnect() # рвем соединение с локальным роутером

  loop_loop
  puts "Connecting"
  error = $conn.Connect() # устанавливаем соединение с локальным роутером

  loop_loop
  puts "Outlogging"
  error = $conn.Logout() # рвем соединение с РТС

  loop_loop
end
