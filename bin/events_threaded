#!/usr/bin/env ruby
# encoding: Windows-1251

require_relative 'start_script'

# This script replicates SimpleSend.js functionality

start_router do

# Now creating Connection object
  @conn = P2::Connection.new(:app_name => "RbConnEventsThreaded",
                             :host => "127.0.0.1",
                             :port => 4001)

# Possible (performance) problems, since STA library is used?
  Thread.new do
    @conn.events.on_event do |*args|
      p "EVENT!!!!!!! #{args.inspect}"
      args[1].ole_type.tap { |k| p [k.name, k.progid, k.guid, k.implemented_ole_types] }
      p @conn.status_text
    end

    print "Event handler created, entering message loop...\n"

    loop do
      @conn.ProcessMessage2(100)
#      WIN32OLE_EVENT.message_loop
      print '.'
    end
  end

  print "Connecting...\n"

  error = @conn.Connect() # устанавливаем соединение с локальным роутером

  print "Disconnecting...\n"

  error = @conn.Disconnect() # рвем соединение с локальным роутером

  print "Connecting...\n"

  error = @conn.Connect() # устанавливаем соединение с локальным роутером

  print "Outlogging...\n"

  error = @conn.Logout() # рвем соединение с РТС

  sleep 0.5
end
