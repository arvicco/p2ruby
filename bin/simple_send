#!/usr/bin/env ruby
# encoding: Windows-1251

require_relative 'script_helper'

# This script replicates SimpleSend.js functionality

start_router do

  # Resetting Application with correct ini file
  P2::Application.reset CLIENT_INI

  # Creating Connection object
  conn = P2::Connection.new(:app_name => "RbOrdSend", # адрес приложения в коммуникациях РТС.
                            :host => "127.0.0.1", # IP Адрес
                            :port => 4001) # и порт локального роутера

  result = conn.Connect() # устанавливаем соединение с локальным роутером

  puts "Connection attempt: #{result}..."

  server_address = conn.ResolveService("FORTS_SRV") # ищем адрес сервера приема заявок

  puts "FORTS_SRV server address: #{server_address}..."

  # создаем и инициализируем фабрику объектов-сообщений
  msgs = P2::MessageFactory.new :ini => MESSAGE_INI

  puts "Msg Factory inited..."

  # создаем и заполняем сообщение
  msg = msgs.message ADD_ORDER_OPTS
  msg.DestAddr = server_address

  puts "Msg created, Sending it..."

  msg = msg.Send(conn, 5000) # посылаем, ждем ответа в течение 5000 миллисекунд

  puts msg.parse_reply #'CP866' #'CP1251'
end
