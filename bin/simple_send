#!/usr/bin/env ruby
# encoding: Windows-1251

require_relative 'start_script'

# This script replicates SimpleSend.js functionality

start_router do

  # Resetting Application with correct ini file
  P2::Application.reset CLIENT_INI

  # Creating Connection object
  conn = P2Ruby::Connection.new(:app_name => "RbOrdSend", # адрес приложения в коммуникациях РТС.
                                :host => "127.0.0.1", # IP Адрес
                                :port => 4001) # и порт локального роутера

  result = conn.Connect() # устанавливаем соединение с локальным роутером

  puts "Connection attempt: #{result}..."

  server_address = conn.ResolveService("FORTS_SRV") # ищем адрес сервера приема заявок

  puts "FORTS_SRV server address: #{server_address}..."

  # создаем и инициализируем фабрику объектов-сообщений
  msgs = P2Ruby::MessageFactory.new :ini => MESSAGE_INI

  puts "Msg Factory inited..."

  # создаем и заполняем сообщение
  msg = msgs.message "FutAddOrder",
                     :dest_addr => server_address,
                     :field => {
                         "P2_Category" => "FORTS_MSG",
                         "P2_Type" => 1,
                         "isin" => "RTS-3.11",
                         :price => "185500",
                         :amount => 1,
                         "client_code" => "001",
                         "type" => 1,
                         "dir" => 1}

  puts "Msg created, Sending it..."

  msg = msg.Send(conn, 5000) # посылаем, ждем ответа в течение 5000 миллисекунд

  puts msg.parse_reply
end
